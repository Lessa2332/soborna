<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–°–æ–±–æ—Ä–Ω–∞ –ü–∏—Å–∞–Ω–∫–∞ | –ö–∞—Ä—Ç–∞ —î–¥–Ω–∞–Ω–Ω—è</title>
  
  <!-- –®—Ä–∏—Ñ—Ç–∏ -->
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  
  <!-- Leaflet –¥–ª—è –∫–∞—Ä—Ç–∏ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <style>
    /* ============ –°–ö–ò–î–ê–ù–ù–Ø –°–¢–ò–õ–Ü–í ============ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    /* ============ –ó–ú–Ü–ù–ù–Ü ============ */
    :root {
      --bordo: #6a1e2a;
      --bordo-light: #8b2f3c;
      --gold: #c9a03d;
      --gold-light: #e5b73b;
      --cream: #f5eee6;
      --brown: #4a2c1a;
      --beige: #e8d9c0;
      --dark: #1a1a1a;
      --font-heading: 'Cormorant Garamond', 'Times New Roman', serif;
      --font-body: 'Open Sans', 'Helvetica', sans-serif;
      --shadow-lg: 0 8px 32px rgba(106, 30, 42, 0.2);
      --shadow-gold: 0 4px 20px rgba(201, 160, 61, 0.3);
      --transition: all 0.3s ease;
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
    }
    
    body {
      font-family: var(--font-body);
      background-color: var(--cream);
      color: var(--dark);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
    }
    
    /* ============ –ö–ê–†–¢–ê ============ */
    #map-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    
    #ukraine-map {
      width: 100%;
      height: 100%;
      background: var(--beige);
      z-index: 1;
    }
    
    /* ============ –ú–ê–†–ö–ï–†–ò –ü–ò–°–ê–ù–û–ö ============ */
    .pysanka-marker {
      background: transparent;
      border: none;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
      transition: transform 0.2s ease;
      cursor: pointer;
      z-index: 10;
    }
    
    .pysanka-marker:active {
      transform: scale(1.3) rotate(10deg);
      filter: drop-shadow(0 12px 24px rgba(255, 215, 0, 0.6));
      z-index: 1000;
    }
    
    /* –†—ñ–∑–Ω–æ–∫–æ–ª—å–æ—Ä–æ–≤—ñ –ø–∏—Å–∞–Ω–∫–∏ */
    .pysanka-egg {
      width: 44px;
      height: 62px;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      border: 2px solid white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      transform: rotate(-5deg);
      position: relative;
      animation: gentleFloat 3s ease-in-out infinite;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      -webkit-backdrop-filter: blur(2px);
      backdrop-filter: blur(2px);
    }
    
    @keyframes gentleFloat {
      0%, 100% { transform: rotate(-5deg) translateY(0); }
      50% { transform: rotate(-5deg) translateY(-5px); }
    }
    
    /* –ö–æ–ª—å–æ—Ä–∏ –ø–∏—Å–∞–Ω–æ–∫ */
    .pysanka-egg.rainbow-1 { background: linear-gradient(135deg, #FF6B6B, #FF8E8E); }
    .pysanka-egg.rainbow-2 { background: linear-gradient(135deg, #FFB347, #FFA07A); }
    .pysanka-egg.rainbow-3 { background: linear-gradient(135deg, #FFD93D, #FFE55C); }
    .pysanka-egg.rainbow-4 { background: linear-gradient(135deg, #6BCB77, #8FDC89); }
    .pysanka-egg.rainbow-5 { background: linear-gradient(135deg, #4D96FF, #6DABFF); }
    .pysanka-egg.rainbow-6 { background: linear-gradient(135deg, #9D65C9, #B47AE8); }
    .pysanka-egg.rainbow-7 { background: linear-gradient(135deg, #FF8A9C, #FFB6C1); }
    .pysanka-egg.rainbow-8 { background: linear-gradient(135deg, #A9D6E5, #C7E9F0); }
    
    .pysanka-egg:after {
      content: '';
      position: absolute;
      top: 4px;
      left: 4px;
      right: 4px;
      bottom: 4px;
      border: 1px solid rgba(255,255,255,0.7);
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      pointer-events: none;
    }
    
    /* ============ –ü–ê–ù–ï–õ–¨ –°–¢–ê–¢–ò–°–¢–ò–ö–ò ============ */
    .stats-panel {
      position: fixed;
      top: calc(10px + var(--safe-area-top));
      right: 10px;
      background: rgba(106, 30, 42, 0.95);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border: 2px solid var(--gold);
      border-radius: 24px;
      padding: 16px;
      color: white;
      z-index: 100;
      min-width: 260px;
      max-width: 280px;
      box-shadow: var(--shadow-lg), 0 0 30px rgba(201, 160, 61, 0.2);
      transition: all 0.3s ease;
      touch-action: pan-y;
    }
    
    .stats-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .stats-title {
      font-family: var(--font-heading);
      font-size: 22px;
      color: var(--gold);
      text-align: center;
      border-bottom: 1px solid var(--gold);
      padding-bottom: 8px;
      flex: 1;
    }
    
    .toggle-stats-btn {
      background: transparent;
      border: 2px solid var(--gold);
      color: var(--gold);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      margin-left: 8px;
      flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    .toggle-stats-btn:active {
      background: var(--gold);
      color: var(--bordo);
      transform: scale(0.95);
    }
    
    .stats-number {
      font-size: 44px;
      font-weight: 700;
      color: var(--gold);
      text-align: center;
      margin: 8px 0;
      line-height: 1;
      text-shadow: 0 0 20px var(--gold);
    }
    
    .stats-label {
      text-align: center;
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 12px;
    }
    
    .progress-container {
      margin-bottom: 16px;
    }
    
    .progress-header {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 6px;
      opacity: 0.9;
    }
    
    .progress-bar-bg {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-bar-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #FF6B6B, #FFD93D, #6BCB77, #4D96FF);
      transition: width 0.5s;
      border-radius: 4px;
    }
    
    .participants-list {
      max-height: 250px;
      overflow-y: auto;
      margin-top: 12px;
      border-top: 1px solid rgba(201, 160, 61, 0.3);
      padding-top: 10px;
      -webkit-overflow-scrolling: touch;
    }
    
    .participant-item {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(201, 160, 61, 0.15);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.2s;
      cursor: pointer;
      border-radius: 12px;
      margin-bottom: 2px;
    }
    
    .participant-item:active {
      background: rgba(201, 160, 61, 0.25);
      transform: translateX(5px);
    }
    
    .participant-symbol {
      font-size: 22px;
      min-width: 36px;
      text-align: center;
      filter: drop-shadow(0 2px 4px var(--gold));
    }
    
    .participant-name {
      color: var(--gold);
      font-weight: 600;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .participant-city {
      color: var(--cream);
      font-size: 11px;
      background: rgba(255,255,255,0.15);
      padding: 3px 8px;
      border-radius: 20px;
      white-space: nowrap;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* ============ –ü–ê–ù–ï–õ–¨ –ö–ï–†–£–í–ê–ù–ù–Ø ============ */
    .control-panel {
      position: fixed;
      bottom: calc(20px + var(--safe-area-bottom));
      right: 10px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .control-btn {
      padding: 12px 20px;
      background: var(--bordo);
      color: var(--gold);
      border: 2px solid var(--gold);
      border-radius: 40px;
      font-family: var(--font-heading);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-backdrop-filter: blur(5px);
      backdrop-filter: blur(5px);
      box-shadow: var(--shadow-lg);
      min-width: 140px;
      text-align: center;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .control-btn:active {
      background: var(--gold);
      color: var(--bordo);
      transform: scale(0.97);
    }
    
    .control-btn.small {
      padding: 8px 16px;
      min-width: 120px;
      font-size: 14px;
    }
    
    .control-btn.admin {
      background: #8B0000;
      border-color: #ff9800;
      color: #ff9800;
    }
    
    /* ============ –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø ============ */
    .toast-message {
      position: fixed;
      top: calc(20px + var(--safe-area-top));
      left: 50%;
      transform: translateX(-50%);
      background: rgba(106, 30, 42, 0.98);
      border: 2px solid var(--gold);
      border-radius: 40px;
      padding: 14px 28px;
      color: white;
      font-size: 16px;
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 10px;
      box-shadow: var(--shadow-lg), 0 0 30px var(--gold);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      animation: slideDown 0.3s ease;
      max-width: 90%;
      text-align: center;
      pointer-events: none;
    }
    
    @keyframes slideDown {
      from { transform: translate(-50%, -100%); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }
    
    /* ============ –°–í–Ø–¢–ö–£–í–ê–ù–ù–Ø ============ */
    .celebration-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255, 215, 0, 0.4), rgba(106, 30, 42, 0.9));
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s;
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
    }
    
    .celebration-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .celebration-content {
      text-align: center;
      color: gold;
      animation: celebrationZoom 0.5s ease;
      padding: 20px;
    }
    
    .celebration-egg {
      font-size: 100px;
      filter: drop-shadow(0 0 30px gold);
      animation: eggSpin 10s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes eggSpin {
      from { transform: rotateY(0deg); }
      to { transform: rotateY(360deg); }
    }
    
    .celebration-title {
      font-family: var(--font-heading);
      font-size: 42px;
      margin: 20px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .celebration-text {
      font-size: 20px;
      margin-bottom: 30px;
    }
    
    /* ============ –ê–î–ú–Ü–ù-–ü–ê–ù–ï–õ–¨ ============ */
    .admin-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    
    .admin-content {
      background: var(--bordo);
      border: 3px solid var(--gold);
      border-radius: 30px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      color: white;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    
    .admin-title {
      color: var(--gold);
      font-family: var(--font-heading);
      font-size: 28px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .admin-btn {
      width: 100%;
      padding: 15px;
      margin-bottom: 10px;
      border: none;
      border-radius: 30px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .admin-btn:active {
      transform: scale(0.98);
    }
    
    .admin-btn.primary {
      background: var(--gold);
      color: var(--bordo);
    }
    
    .admin-btn.warning {
      background: #ff9800;
      color: white;
    }
    
    .admin-btn.danger {
      background: #f44336;
      color: white;
    }
    
    .admin-stats {
      background: rgba(0,0,0,0.3);
      border-radius: 20px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .admin-close {
      width: 100%;
      padding: 15px;
      margin-top: 20px;
      background: transparent;
      border: 2px solid var(--gold);
      color: var(--gold);
      border-radius: 30px;
      cursor: pointer;
    }
    
    /* ============ –ö–ù–û–ü–ö–ê –ê–î–ú–Ü–ù–ê ============ */
    .admin-trigger {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 150;
      background: rgba(106, 30, 42, 0.9);
      backdrop-filter: blur(10px);
      padding: 10px 20px;
      border-radius: 50px;
      border: 2px solid var(--gold);
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      display: flex;
      gap: 10px;
    }
    
    .admin-trigger-btn {
      background: var(--gold);
      color: var(--bordo);
      border: none;
      padding: 8px 15px;
      border-radius: 30px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    
    /* ============ –ê–î–ê–ü–¢–ê–¶–Ü–Ø ============ */
    @media (max-width: 380px) {
      .stats-panel {
        min-width: 220px;
        padding: 12px;
      }
      
      .stats-title {
        font-size: 20px;
      }
      
      .stats-number {
        font-size: 38px;
      }
      
      .control-btn {
        min-width: 120px;
        padding: 10px 16px;
        font-size: 14px;
      }
      
      .pysanka-egg {
        width: 38px;
        height: 54px;
        font-size: 20px;
      }
      
      .admin-trigger {
        padding: 8px 12px;
      }
      
      .admin-trigger-btn {
        padding: 6px 10px;
        font-size: 12px;
      }
    }
    
    @supports (padding: max(0px)) {
      .stats-panel {
        top: max(10px, env(safe-area-inset-top));
        right: max(10px, env(safe-area-inset-right));
      }
      
      .control-panel {
        bottom: max(20px, env(safe-area-inset-bottom));
        right: max(10px, env(safe-area-inset-right));
      }
      
      .toast-message {
        top: max(20px, env(safe-area-inset-top));
      }
      
      .admin-trigger {
        bottom: max(20px, env(safe-area-inset-bottom));
      }
    }
  </style>
</head>
<body>
  <div id="map-container">
    <div id="ukraine-map"></div>
  </div>
  
  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="stats-panel" id="statsPanel">
    <div class="stats-header">
      <div class="stats-title">üå∏ –ü–ò–°–ê–ù–ö–ê üå∏</div>
      <button class="toggle-stats-btn" onclick="toggleStats()" id="toggleStatsBtn" title="–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É">
        üëÅÔ∏è
      </button>
    </div>
    
    <div id="statsContent">
      <div class="stats-number" id="participantCount">0</div>
      <div class="stats-label">—É—á–∞—Å–Ω–∏–∫—ñ–≤</div>
      
      <div class="progress-container">
        <div class="progress-header">
          <span>14 —Ä–µ–≥—ñ–æ–Ω—ñ–≤</span>
          <span id="regionsActive">0/14</span>
        </div>
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" id="progressBar"></div>
        </div>
      </div>
      
      <div class="participants-list" id="participantsList">
        <div style="text-align: center; opacity: 0.5; padding: 20px;">–ß–µ–∫–∞—î–º–æ –Ω–∞ —É—á–∞—Å–Ω–∏–∫—ñ–≤...</div>
      </div>
    </div>
  </div>
  
  <!-- –ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è -->
  <div class="control-panel">
    <button class="control-btn" onclick="refreshMap()" id="refreshBtn">
      üîÑ –û–Ω–æ–≤–∏—Ç–∏
    </button>
    <button class="control-btn" onclick="showCelebration()" id="celebrateBtn" style="display: none;">
      üéâ –°–≤—è—Ç–∫—É–≤–∞—Ç–∏
    </button>
    <button class="control-btn small" onclick="window.location.href='phase1.html'">
      ü•ö –ü–æ—á–∞—Ç–∏
    </button>
  </div>
  
  <!-- –ö–Ω–æ–ø–∫–∞ –∞–¥–º—ñ–Ω–∞ -->
  <div class="admin-trigger">
    <button class="admin-trigger-btn" onclick="showAdminPanel()">
      üîß –ê–¥–º—ñ–Ω
    </button>
    <button class="admin-trigger-btn" onclick="quickCleanEmpty()" title="–®–≤–∏–¥–∫–µ –æ—á–∏—â–µ–Ω–Ω—è –ø—É—Å—Ç–∏—Ö">
      üßπ
    </button>
  </div>
  
  <!-- –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å -->
  <div class="admin-modal" id="adminModal">
    <div class="admin-content">
      <h2 class="admin-title">üîß –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h2>
      
      <button class="admin-btn primary" onclick="syncWithGoogleSheets()">
        üîÑ –ü—Ä–∏–º—É—Å–æ–≤–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ Google Sheets
      </button>
      
      <button class="admin-btn warning" onclick="cleanEmptyParticipants()">
        üßπ –û—á–∏—Å—Ç–∏—Ç–∏ –ø—É—Å—Ç–∏—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤ (–±–µ–∑ –º—ñ—Å—Ç–∞)
      </button>
      
      <button class="admin-btn danger" onclick="resetLocalData()">
        üóëÔ∏è –ü–æ–≤–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö –¥–∞–Ω–∏—Ö
      </button>
      
      <div class="admin-stats" id="adminStats">
        –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...
      </div>
      
      <div id="emptyParticipantsList" style="max-height:200px; overflow-y:auto; margin-top:10px;"></div>
      
      <button class="admin-close" onclick="closeAdminPanel()">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
  </div>
  
  <!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
  <div class="toast-message" id="toastMessage">
    <span>üå∏</span>
    <span id="toastText">–ù–æ–≤–∏–π —É—á–∞—Å–Ω–∏–∫!</span>
  </div>
  
  <!-- –°–≤—è—Ç–∫—É–≤–∞–Ω–Ω—è -->
  <div class="celebration-overlay" id="celebrationOverlay" onclick="hideCelebration()">
    <div class="celebration-content">
      <div class="celebration-egg">ü•ö</div>
      <div class="celebration-title">–í–ï–°–ù–ê –ü–ï–†–ï–ú–û–ì–ò!</div>
      <div class="celebration-text">–ú–∏ —Å–æ–±–æ—Ä–Ω—ñ!</div>
      <button class="control-btn" onclick="event.stopPropagation(); hideCelebration()" style="background: var(--gold); color: var(--bordo); margin: 0 auto;">
        –î–æ –∫–∞—Ä—Ç–∏
      </button>
    </div>
  </div>
  
  <script>
    // ============ –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø ============
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzEnTeoAdgYv_4DTh3P9g8BPILmXPi4B7FTrHz-54q7nZxpPBEvejaWsIP_jWjZQtdM/exec';
    
    // ============ –†–û–ó–®–ò–†–ï–ù–ò–ô –°–ü–ò–°–û–ö –ö–û–û–†–î–ò–ù–ê–¢ –ú–Ü–°–¢ ============
    const CITY_COORDS = {
      // –û–±–ª–∞—Å–Ω—ñ —Ü–µ–Ω—Ç—Ä–∏
      '–≤—ñ–Ω–Ω–∏—Ü—è': { lat: 49.23, lng: 28.47, regionId: 1, region: '–ü–æ–¥—ñ–ª–ª—è' },
      '—Ö–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π': { lat: 49.42, lng: 26.98, regionId: 1, region: '–ü–æ–¥—ñ–ª–ª—è' },
      '—Ç–µ—Ä–Ω–æ–ø—ñ–ª—å': { lat: 49.55, lng: 25.59, regionId: 1, region: '–ü–æ–¥—ñ–ª–ª—è' },
      '–∂–∏—Ç–æ–º–∏—Ä': { lat: 50.25, lng: 28.66, regionId: 2, region: '–ü–æ–ª—ñ—Å—Å—è' },
      '—á–µ—Ä–Ω—ñ–≥—ñ–≤': { lat: 51.50, lng: 31.29, regionId: 2, region: '–ü–æ–ª—ñ—Å—Å—è' },
      '—Ä—ñ–≤–Ω–µ': { lat: 50.62, lng: 26.25, regionId: 2, region: '–ü–æ–ª—ñ—Å—Å—è' },
      '–ª—É—Ü—å–∫': { lat: 50.75, lng: 25.34, regionId: 2, region: '–ü–æ–ª—ñ—Å—Å—è' },
      '—ñ–≤–∞–Ω–æ-—Ñ—Ä–∞–Ω–∫—ñ–≤—Å—å–∫': { lat: 48.92, lng: 24.71, regionId: 3, region: '–ö–∞—Ä–ø–∞—Ç–∏' },
      '—É–∂–≥–æ—Ä–æ–¥': { lat: 48.62, lng: 22.30, regionId: 3, region: '–ö–∞—Ä–ø–∞—Ç–∏' },
      '—á–µ—Ä–Ω—ñ–≤—Ü—ñ': { lat: 48.29, lng: 25.94, regionId: 3, region: '–ö–∞—Ä–ø–∞—Ç–∏' },
      '–∫–∏—ó–≤': { lat: 50.45, lng: 30.52, regionId: 4, region: '–ö–∏—ó–≤—â–∏–Ω–∞' },
      '–ª—å–≤—ñ–≤': { lat: 49.84, lng: 24.03, regionId: 5, region: '–õ—å–≤—ñ–≤—â–∏–Ω–∞' },
      '–æ–¥–µ—Å–∞': { lat: 46.48, lng: 30.72, regionId: 6, region: '–û–¥–µ—â–∏–Ω–∞' },
      '—Ö–∞—Ä–∫—ñ–≤': { lat: 49.99, lng: 36.23, regionId: 7, region: '–•–∞—Ä–∫—ñ–≤—â–∏–Ω–∞' },
      '–¥–Ω—ñ–ø—Ä–æ': { lat: 48.46, lng: 35.04, regionId: 8, region: '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞' },
      '–ø–æ–ª—Ç–∞–≤–∞': { lat: 49.59, lng: 34.55, regionId: 9, region: '–ü–æ–ª—Ç–∞–≤—â–∏–Ω–∞' },
      '—á–µ—Ä–∫–∞—Å–∏': { lat: 49.44, lng: 32.06, regionId: 11, region: '–ß–µ—Ä–∫–∞—â–∏–Ω–∞' },
      '—Å—ñ–º—Ñ–µ—Ä–æ–ø–æ–ª—å': { lat: 44.95, lng: 34.10, regionId: 12, region: '–ö—Ä–∏–º' },
      '–¥–æ–Ω–µ—Ü—å–∫': { lat: 48.02, lng: 37.80, regionId: 13, region: '–î–æ–Ω–µ—á—á–∏–Ω–∞' },
      '–ª—É–≥–∞–Ω—Å—å–∫': { lat: 48.57, lng: 39.31, regionId: 14, region: '–õ—É–≥–∞–Ω—â–∏–Ω–∞' },
      
      // –û–¥–µ—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
      '—á–æ—Ä–Ω–æ–º–æ—Ä—Å—å–∫': { lat: 46.30, lng: 30.66, regionId: 6, region: '–û–¥–µ—â–∏–Ω–∞' },
      '—ñ–∑–º–∞—ó–ª': { lat: 45.35, lng: 28.84, regionId: 6, region: '–û–¥–µ—â–∏–Ω–∞' },
      '–±—ñ–ª–≥–æ—Ä–æ–¥-–¥–Ω—ñ—Å—Ç—Ä–æ–≤—Å—å–∫–∏–π': { lat: 46.18, lng: 30.34, regionId: 6, region: '–û–¥–µ—â–∏–Ω–∞' },
      '–ø–æ–¥—ñ–ª—å—Å—å–∫': { lat: 47.74, lng: 29.53, regionId: 6, region: '–û–¥–µ—â–∏–Ω–∞' },
      '—é–∂–Ω–µ': { lat: 46.62, lng: 31.10, regionId: 6, region: '–û–¥–µ—â–∏–Ω–∞' },
      
      // –ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
      '—É–º–∞–Ω—å': { lat: 48.75, lng: 30.22, regionId: 11, region: '–ß–µ—Ä–∫–∞—â–∏–Ω–∞' },
      '—Å–º–æ–ª–∞': { lat: 49.22, lng: 31.87, regionId: 11, region: '–ß–µ—Ä–∫–∞—â–∏–Ω–∞' },
      '–∑–æ–ª–æ—Ç–æ–Ω–æ—à–∞': { lat: 49.67, lng: 32.04, regionId: 11, region: '–ß–µ—Ä–∫–∞—â–∏–Ω–∞' },
      '–∫–∞–Ω—ñ–≤': { lat: 49.75, lng: 31.47, regionId: 11, region: '–ß–µ—Ä–∫–∞—â–∏–Ω–∞' },
      '–∫–æ—Ä—Å—É–Ω—å-—à–µ–≤—á–µ–Ω–∫—ñ–≤—Å—å–∫–∏–π': { lat: 49.42, lng: 31.26, regionId: 11, region: '–ß–µ—Ä–∫–∞—â–∏–Ω–∞' },
      
      // –ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
      '–±—ñ–ª–∞ —Ü–µ—Ä–∫–≤–∞': { lat: 49.80, lng: 30.12, regionId: 4, region: '–ö–∏—ó–≤—â–∏–Ω–∞' },
      '–±—Ä–æ–≤–∞—Ä–∏': { lat: 50.51, lng: 30.79, regionId: 4, region: '–ö–∏—ó–≤—â–∏–Ω–∞' },
      '–±–æ—Ä–∏—Å–ø—ñ–ª—å': { lat: 50.35, lng: 30.95, regionId: 4, region: '–ö–∏—ó–≤—â–∏–Ω–∞' },
      '—Ñ–∞—Å—Ç—ñ–≤': { lat: 50.07, lng: 29.92, regionId: 4, region: '–ö–∏—ó–≤—â–∏–Ω–∞' },
      '—ñ—Ä–ø—ñ–Ω—å': { lat: 50.52, lng: 30.25, regionId: 4, region: '–ö–∏—ó–≤—â–∏–Ω–∞' },
      '–≤–∏—à–≥–æ—Ä–æ–¥': { lat: 50.58, lng: 30.49, regionId: 4, region: '–ö–∏—ó–≤—â–∏–Ω–∞' },
      '–æ–±—É—Ö—ñ–≤': { lat: 50.11, lng: 30.63, regionId: 4, region: '–ö–∏—ó–≤—â–∏–Ω–∞' },
      
      // –õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
      '–¥—Ä–æ–≥–æ–±–∏—á': { lat: 49.35, lng: 23.51, regionId: 5, region: '–õ—å–≤—ñ–≤—â–∏–Ω–∞' },
      '—Å—Ç—Ä–∏–π': { lat: 49.25, lng: 23.85, regionId: 5, region: '–õ—å–≤—ñ–≤—â–∏–Ω–∞' },
      '—Å–∞–º–±—ñ—Ä': { lat: 49.52, lng: 23.20, regionId: 5, region: '–õ—å–≤—ñ–≤—â–∏–Ω–∞' },
      '—Ç—Ä—É—Å–∫–∞–≤–µ—Ü—å': { lat: 49.28, lng: 23.51, regionId: 5, region: '–õ—å–≤—ñ–≤—â–∏–Ω–∞' },
      '–Ω–æ–≤–æ—è–≤–æ—Ä—ñ–≤—Å—å–∫': { lat: 49.93, lng: 23.57, regionId: 5, region: '–õ—å–≤—ñ–≤—â–∏–Ω–∞' },
      '—á–µ—Ä–≤–æ–Ω–æ–≥—Ä–∞–¥': { lat: 50.39, lng: 24.23, regionId: 5, region: '–õ—å–≤—ñ–≤—â–∏–Ω–∞' },
      
      // –î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
      '–∫—Ä–∏–≤–∏–π —Ä—ñ–≥': { lat: 47.91, lng: 33.39, regionId: 8, region: '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞' },
      '–∫–∞–º—ñ–Ω—å—Å—å–∫–µ': { lat: 48.52, lng: 34.61, regionId: 8, region: '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞' },
      '–Ω—ñ–∫–æ–ø–æ–ª—å': { lat: 47.57, lng: 34.39, regionId: 8, region: '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞' },
      '–ø–∞–≤–ª–æ–≥—Ä–∞–¥': { lat: 48.52, lng: 35.87, regionId: 8, region: '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞' },
      '–Ω–æ–≤–æ–º–æ—Å–∫–æ–≤—Å—å–∫': { lat: 48.63, lng: 35.22, regionId: 8, region: '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞' },
      '–∂–æ–≤—Ç—ñ –≤–æ–¥–∏': { lat: 48.35, lng: 33.50, regionId: 8, region: '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞' },
      '–º–∞—Ä–≥–∞–Ω–µ—Ü—å': { lat: 47.65, lng: 34.62, regionId: 8, region: '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞' },
      
      // –î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
      '–º–∞—Ä—ñ—É–ø–æ–ª—å': { lat: 47.10, lng: 37.55, regionId: 13, region: '–î–æ–Ω–µ—á—á–∏–Ω–∞' },
      '–∫—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫': { lat: 48.72, lng: 37.53, regionId: 13, region: '–î–æ–Ω–µ—á—á–∏–Ω–∞' },
      '—Å–ª–æ–≤—è–Ω—Å—å–∫': { lat: 48.85, lng: 37.61, regionId: 13, region: '–î–æ–Ω–µ—á—á–∏–Ω–∞' },
      '–±–∞—Ö–º—É—Ç': { lat: 48.60, lng: 38.00, regionId: 13, region: '–î–æ–Ω–µ—á—á–∏–Ω–∞' },
      '–ø–æ–∫—Ä–æ–≤—Å—å–∫': { lat: 48.28, lng: 37.18, regionId: 13, region: '–î–æ–Ω–µ—á—á–∏–Ω–∞' },
      '–≥–æ—Ä–ª—ñ–≤–∫–∞': { lat: 48.33, lng: 38.09, regionId: 13, region: '–î–æ–Ω–µ—á—á–∏–Ω–∞' },
      '–º–∞–∫—ñ—ó–≤–∫–∞': { lat: 48.05, lng: 37.97, regionId: 13, region: '–î–æ–Ω–µ—á—á–∏–Ω–∞' },
      
      // –•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
      '—Å—É–º–∏': { lat: 50.91, lng: 34.80, regionId: 7, region: '–•–∞—Ä–∫—ñ–≤—â–∏–Ω–∞' },
      '—ñ–∑—é–º': { lat: 49.19, lng: 37.27, regionId: 7, region: '–•–∞—Ä–∫—ñ–≤—â–∏–Ω–∞' },
      '–ª–æ–∑–æ–≤–∞': { lat: 48.89, lng: 36.31, regionId: 7, region: '–•–∞—Ä–∫—ñ–≤—â–∏–Ω–∞' },
      '—á—É–≥—É—ó–≤': { lat: 49.84, lng: 36.68, regionId: 7, region: '–•–∞—Ä–∫—ñ–≤—â–∏–Ω–∞' },
      '–ø–µ—Ä–≤–æ–º–∞–π—Å—å–∫–∏–π': { lat: 49.39, lng: 36.21, regionId: 7, region: '–•–∞—Ä–∫—ñ–≤—â–∏–Ω–∞' },
      
      // –ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
      '–º–µ–ª—ñ—Ç–æ–ø–æ–ª—å': { lat: 46.84, lng: 35.36, regionId: 8, region: '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞' },
      '–±–µ—Ä–¥—è–Ω—Å—å–∫': { lat: 46.75, lng: 36.79, regionId: 8, region: '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞' },
      '–µ–Ω–µ—Ä–≥–æ–¥–∞—Ä': { lat: 47.50, lng: 34.66, regionId: 8, region: '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞' },
      '—Ç–æ–∫–º–∞–∫': { lat: 47.25, lng: 35.71, regionId: 8, region: '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞' },
      '–ø–æ–ª–æ–≥–∏': { lat: 47.48, lng: 36.25, regionId: 8, region: '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞' },
      
      // –ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
      '–∫—Ä–µ–º–µ–Ω—á—É–∫': { lat: 49.06, lng: 33.40, regionId: 9, region: '–ü–æ–ª—Ç–∞–≤—â–∏–Ω–∞' },
      '–ª—É–±–Ω–∏': { lat: 50.02, lng: 33.00, regionId: 9, region: '–ü–æ–ª—Ç–∞–≤—â–∏–Ω–∞' },
      '–º–∏—Ä–≥–æ—Ä–æ–¥': { lat: 49.97, lng: 33.61, regionId: 9, region: '–ü–æ–ª—Ç–∞–≤—â–∏–Ω–∞' },
      '–≥–∞–¥—è—á': { lat: 50.37, lng: 34.00, regionId: 9, region: '–ü–æ–ª—Ç–∞–≤—â–∏–Ω–∞' },
      
      // –í–æ–ª–∏–Ω—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
      '–≤–æ–ª–æ–¥–∏–º–∏—Ä': { lat: 50.85, lng: 24.32, regionId: 2, region: '–ü–æ–ª—ñ—Å—Å—è' },
      '–∫–æ–≤–µ–ª—å': { lat: 51.22, lng: 24.71, regionId: 2, region: '–ü–æ–ª—ñ—Å—Å—è' },
      '–Ω–æ–≤–æ–≤–æ–ª–∏–Ω—Å—å–∫': { lat: 50.74, lng: 24.16, regionId: 2, region: '–ü–æ–ª—ñ—Å—Å—è' },
      
      // –ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
      '–º—É–∫–∞—á–µ–≤–æ': { lat: 48.44, lng: 22.71, regionId: 3, region: '–ö–∞—Ä–ø–∞—Ç–∏' },
      '—Ö—É—Å—Ç': { lat: 48.18, lng: 23.30, regionId: 3, region: '–ö–∞—Ä–ø–∞—Ç–∏' },
      '–±–µ—Ä–µ–≥–æ–≤–æ': { lat: 48.20, lng: 22.64, regionId: 3, region: '–ö–∞—Ä–ø–∞—Ç–∏' },
      '—á–æ–ø': { lat: 48.43, lng: 22.21, regionId: 3, region: '–ö–∞—Ä–ø–∞—Ç–∏' },
      '—Ä–∞—Ö—ñ–≤': { lat: 48.06, lng: 24.21, regionId: 3, region: '–ö–∞—Ä–ø–∞—Ç–∏' },
      
      // –Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
      '–∫–∞–ª—É—à': { lat: 49.01, lng: 24.37, regionId: 3, region: '–ö–∞—Ä–ø–∞—Ç–∏' },
      '–∫–æ–ª–æ–º–∏—è': { lat: 48.53, lng: 25.04, regionId: 3, region: '–ö–∞—Ä–ø–∞—Ç–∏' },
      '–Ω–∞–¥–≤—ñ—Ä–Ω–∞': { lat: 48.63, lng: 24.57, regionId: 3, region: '–ö–∞—Ä–ø–∞—Ç–∏' },
      '–¥–æ–ª–∏–Ω–∞': { lat: 48.97, lng: 24.01, regionId: 3, region: '–ö–∞—Ä–ø–∞—Ç–∏' },
      
      // –ö—Ä–∏–º
      '—è–ª—Ç–∞': { lat: 44.50, lng: 34.17, regionId: 12, region: '–ö—Ä–∏–º' },
      '—Ñ–µ–æ–¥–æ—Å—ñ—è': { lat: 45.03, lng: 35.38, regionId: 12, region: '–ö—Ä–∏–º' },
      '—î–≤–ø–∞—Ç–æ—Ä—ñ—è': { lat: 45.20, lng: 33.36, regionId: 12, region: '–ö—Ä–∏–º' },
      '–∫–µ—Ä—á': { lat: 45.36, lng: 36.47, regionId: 12, region: '–ö—Ä–∏–º' },
      '—Å–∞–∫–∏': { lat: 45.13, lng: 33.60, regionId: 12, region: '–ö—Ä–∏–º' },
      '–¥–∂–∞–Ω–∫–æ–π': { lat: 45.71, lng: 34.39, regionId: 12, region: '–ö—Ä–∏–º' },
      '–∞–ª—É—à—Ç–∞': { lat: 44.67, lng: 34.41, regionId: 12, region: '–ö—Ä–∏–º' },
      '—Å—É–¥–∞–∫': { lat: 44.85, lng: 34.98, regionId: 12, region: '–ö—Ä–∏–º' },
      
      // ============ –ú–Ü–°–¢–ê –î–Ü–ê–°–ü–û–†–ò ============
      '—Ç–æ—Ä–æ–Ω—Ç–æ': { lat: 43.65, lng: -79.38, country: '–ö–∞–Ω–∞–¥–∞', isDiaspora: true },
      '—á–∏–∫–∞–≥–æ': { lat: 41.88, lng: -87.63, country: '–°–®–ê', isDiaspora: true },
      '–Ω—å—é-–π–æ—Ä–∫': { lat: 40.71, lng: -74.01, country: '–°–®–ê', isDiaspora: true },
      '–≤–∞—Ä—à–∞–≤–∞': { lat: 52.23, lng: 21.01, country: '–ü–æ–ª—å—â–∞', isDiaspora: true },
      '–±–µ—Ä–ª—ñ–Ω': { lat: 52.52, lng: 13.40, country: '–ù—ñ–º–µ—á—á–∏–Ω–∞', isDiaspora: true },
      '–ª–æ–Ω–¥–æ–Ω': { lat: 51.51, lng: -0.13, country: '–í–µ–ª–∏–∫–∞ –ë—Ä–∏—Ç–∞–Ω—ñ—è', isDiaspora: true },
      '–ø–∞—Ä–∏–∂': { lat: 48.86, lng: 2.35, country: '–§—Ä–∞–Ω—Ü—ñ—è', isDiaspora: true },
      '—Ä–∏–º': { lat: 41.90, lng: 12.50, country: '–Ü—Ç–∞–ª—ñ—è', isDiaspora: true },
      '–º–∞–¥—Ä–∏–¥': { lat: 40.42, lng: -3.70, country: '–Ü—Å–ø–∞–Ω—ñ—è', isDiaspora: true },
      '–ª—ñ—Å–∞–±–æ–Ω': { lat: 38.72, lng: -9.14, country: '–ü–æ—Ä—Ç—É–≥–∞–ª—ñ—è', isDiaspora: true },
      '–ø—Ä–∞–≥–∞': { lat: 50.08, lng: 14.42, country: '–ß–µ—Ö—ñ—è', isDiaspora: true },
      '–≤—ñ–¥–µ–Ω—å': { lat: 48.21, lng: 16.37, country: '–ê–≤—Å—Ç—Ä—ñ—è', isDiaspora: true },
      '–±—É–¥–∞–ø–µ—à—Ç': { lat: 47.50, lng: 19.04, country: '–£–≥–æ—Ä—â–∏–Ω–∞', isDiaspora: true }
    };

    // ============ –§–£–ù–ö–¶–Ü–Ø –î–õ–Ø –ó–ù–ê–•–û–î–ñ–ï–ù–ù–Ø –ö–û–û–†–î–ò–ù–ê–¢ –ú–Ü–°–¢–ê ============
    function findCityCoords(cityInput) {
      if (!cityInput) return { lat: 49.0, lng: 32.0, region: '–£–∫—Ä–∞—ó–Ω–∞' };
      
      const cityLower = cityInput.toLowerCase().trim();
      
      // 1. –¢–æ—á–Ω–∏–π –∑–±—ñ–≥
      if (CITY_COORDS[cityLower]) {
        return CITY_COORDS[cityLower];
      }
      
      // 2. –ß–∞—Å—Ç–∫–æ–≤–∏–π –∑–±—ñ–≥
      for (let [key, value] of Object.entries(CITY_COORDS)) {
        if (cityLower.includes(key) || key.includes(cityLower)) {
          console.log(`‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ –º—ñ—Å—Ç–æ: ${key}`);
          return value;
        }
      }
      
      // 3. –°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –≤–∏–ø–∞–¥–∫–∏
      if (cityLower.includes('–∫—Ä–∏–º') || cityLower.includes('crimea')) {
        return { lat: 45.0, lng: 34.0, regionId: 12, region: '–ö—Ä–∏–º' };
      }
      
      if (cityLower.includes('–¥–æ–Ω–±–∞—Å') || cityLower.includes('donbas')) {
        return { lat: 48.0, lng: 37.8, regionId: 13, region: '–î–æ–Ω–±–∞—Å' };
      }
      
      // 4. –¶–µ–Ω—Ç—Ä –£–∫—Ä–∞—ó–Ω–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
      console.log(`‚ùå –ú—ñ—Å—Ç–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: ${cityInput}, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ü–µ–Ω—Ç—Ä`);
      return { lat: 49.0, lng: 32.0, region: '–£–∫—Ä–∞—ó–Ω–∞' };
    }
    
    // ============ –ú–ê–°–ò–í –ö–û–õ–¨–û–†–Ü–í ============
    const RAINBOW_CLASSES = [
      'rainbow-1', 'rainbow-2', 'rainbow-3', 'rainbow-4',
      'rainbow-5', 'rainbow-6', 'rainbow-7', 'rainbow-8'
    ];
    
    // ============ –°–ò–ú–í–û–õ–ò –†–ï–ì–Ü–û–ù–Ü–í ============
    const REGION_SYMBOLS = {
      1: 'üåª', 2: 'üå≤', 3: 'üèîÔ∏è', 4: 'üèõÔ∏è', 5: 'ü¶Å', 6: '‚öì', 7: '‚öôÔ∏è',
      8: 'üåä', 9: 'üåæ', 10: 'üìö', 11: 'üé≠', 12: 'üèñÔ∏è', 13: '‚õèÔ∏è', 14: 'üåª'
    };
    
    // ============ –ó–ú–Ü–ù–ù–Ü ============
    let map;
    let markers = [];
    let participants = [];
    let previousCount = 0;
    let statsVisible = true;
    
    // ============ –ê–í–¢–û–ú–ê–¢–ò–ß–ù–ï –û–ß–ò–©–ï–ù–ù–Ø –ü–†–ò –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ü ============
    function autoCleanOnLoad() {
      try {
        const saved = localStorage.getItem('pysanka_participants');
        if (saved) {
          const data = JSON.parse(saved);
          const validData = data.filter(p => 
            p.city && 
            p.city.trim() !== '' && 
            p.city !== 'undefined' && 
            p.city !== 'null' &&
            p.name && 
            p.name.trim() !== ''
          );
          
          if (data.length !== validData.length) {
            console.log(`üßπ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—á–∏—â–µ–Ω–æ ${data.length - validData.length} –ø—É—Å—Ç–∏—Ö –∑–∞–ø–∏—Å—ñ–≤`);
            localStorage.setItem('pysanka_participants', JSON.stringify(validData));
          }
        }
      } catch (e) {
        console.log('–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ–æ—á–∏—â–µ–Ω–Ω—è:', e);
      }
    }
    
    // ============ –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ============
    document.addEventListener('DOMContentLoaded', function() {
      autoCleanOnLoad();
      initMap();
      loadParticipants();
      setInterval(loadParticipants, 5000);
      
      document.body.addEventListener('touchmove', (e) => {
        if (e.target.closest('.participants-list') || e.target.closest('.admin-content')) return;
        e.preventDefault();
      }, { passive: false });
    });
    
    // ============ –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ö–ê–†–¢–ò ============
    function initMap() {
      map = L.map('ukraine-map', {
        zoomControl: false,
        attributionControl: false,
        fadeAnimation: true,
        zoomAnimation: true,
        markerZoomAnimation: true
      }).setView([49.0, 32.0], 6);
      
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 10,
        minZoom: 5
      }).addTo(map);
      
      if (window.innerWidth < 768) {
        L.control.zoom({ position: 'bottomleft' }).addTo(map);
      }
    }
    
    // ============ –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –£–ß–ê–°–ù–ò–ö–Ü–í ============
    function loadParticipants() {
      loadFromLocalStorage();
      loadFromGoogleSheets();
    }
    
    // ============ –ó LOCALSTORAGE ============
    function loadFromLocalStorage() {
      try {
        const saved = localStorage.getItem('pysanka_participants');
        if (saved) {
          const data = JSON.parse(saved);
          if (data.length > 0) {
            participants = data;
            updateMap();
            updateStats();
            
            if (data.length > previousCount) {
              showNewParticipantToast(data[data.length - 1]);
              previousCount = data.length;
            }
          }
        }
      } catch (e) {}
    }
    
    // ============ –ó GOOGLE SHEETS ============
    function loadFromGoogleSheets() {
      fetch(GOOGLE_SCRIPT_URL)
        .then(response => response.json())
        .then(data => {
          if (data && data.length > 0) {
            const validGoogleData = data.filter(item => 
              item.city && 
              item.city.trim() !== '' && 
              item.name && 
              item.name.trim() !== ''
            );
            
            const googleParticipants = validGoogleData.map(item => {
              const cityCoords = findCityCoords(item.city);
              
              return {
                name: item.name,
                city: item.city,
                region: cityCoords.region || item.regionName || '–£–∫—Ä–∞—ó–Ω–∞',
                regionId: cityCoords.regionId || item.regionId || null,
                country: cityCoords.country || '–£–∫—Ä–∞—ó–Ω–∞',
                timestamp: item.timestamp,
                coords: { lat: cityCoords.lat, lng: cityCoords.lng },
                symbol: REGION_SYMBOLS[cityCoords.regionId || item.regionId] || 'ü•ö',
                isDiaspora: cityCoords.isDiaspora || false
              };
            });
            
            const allParticipants = [...participants];
            
            googleParticipants.forEach(gp => {
              const exists = allParticipants.some(p => 
                p.name === gp.name && p.city === gp.city
              );
              if (!exists) {
                allParticipants.push(gp);
              }
            });
            
            if (allParticipants.length > participants.length) {
              participants = allParticipants;
              localStorage.setItem('pysanka_participants', JSON.stringify(participants));
              updateMap();
              updateStats();
            }
          }
        })
        .catch(() => {});
    }
    
    // ============ –û–ù–û–í–õ–ï–ù–ù–Ø –ö–ê–†–¢–ò ============
    function updateMap() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      
      if (!participants || participants.length === 0) return;
      
      const regionCount = {};
      
      participants.forEach((p, index) => {
        const coords = p.coords || { lat: 49.0, lng: 32.0 };
        const regionId = p.regionId;
        
        if (regionId) regionCount[regionId] = (regionCount[regionId] || 0) + 1;
        
        const colorClass = RAINBOW_CLASSES[index % RAINBOW_CLASSES.length];
        const marker = createMarker(p, coords.lat, coords.lng, colorClass);
        marker.addTo(map);
        markers.push(marker);
      });
      
      updateRegionProgress(regionCount);
    }
    
    // ============ –°–¢–í–û–†–ï–ù–ù–Ø –ú–ê–†–ö–ï–†–ê ============
    function createMarker(participant, lat, lng, colorClass) {
      const symbol = participant.symbol || 'ü•ö';
      
      const markerHtml = `
        <div class="pysanka-marker" title="${participant.name}, ${participant.city}">
          <div class="pysanka-egg ${colorClass}">
            ${symbol}
          </div>
        </div>
      `;
      
      const icon = L.divIcon({
        className: '',
        html: markerHtml,
        iconSize: [44, 62],
        iconAnchor: [22, 31],
        popupAnchor: [0, -31]
      });
      
      const marker = L.marker([lat, lng], { icon: icon });
      
      const diasporaText = participant.isDiaspora ? '<br><small style="color:#ff9800;">üá∫üá¶ –°–µ—Ä—Ü–µ –∑ –£–∫—Ä–∞—ó–Ω–æ—é</small>' : '';
      
      marker.bindPopup(`
        <div style="text-align: center; font-family: 'Cormorant Garamond', serif; min-width: 140px; padding: 5px;">
          <div style="font-size: 28px; margin-bottom: 5px;">${symbol}</div>
          <b style="color: #6a1e2a; font-size: 16px;">${participant.name}</b><br>
          <i style="color: #c9a03d; font-size: 14px;">${participant.city}</i>
          ${participant.country ? `<br><small style="color: #666;">${participant.country}</small>` : ''}
          ${diasporaText}
        </div>
      `, {
        className: 'custom-popup',
        closeButton: false
      });
      
      return marker;
    }
    
    // ============ –û–ù–û–í–õ–ï–ù–ù–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò ============
    function updateStats() {
      const count = participants.length;
      document.getElementById('participantCount').textContent = count;
      
      const listEl = document.getElementById('participantsList');
      
      if (count === 0) {
        listEl.innerHTML = '<div style="text-align: center; opacity: 0.5; padding: 20px;">–ß–µ–∫–∞—î–º–æ –Ω–∞ —É—á–∞—Å–Ω–∏–∫—ñ–≤...</div>';
        return;
      }
      
      const recentParticipants = [...participants].reverse().slice(0, 8);
      
      listEl.innerHTML = recentParticipants.map((p, i) => {
        const colorIndex = i % RAINBOW_CLASSES.length;
        return `
          <div class="participant-item" onclick="flyToParticipant('${p.name.replace(/'/g, "\\'")}')">
            <span class="participant-symbol">${p.symbol || 'ü•ö'}</span>
            <span class="participant-name">${p.name}</span>
            <span class="participant-city">${p.city}</span>
          </div>
        `;
      }).join('');
      
      if (count > 30 && statsVisible) {
        setTimeout(() => {
          if (statsVisible && count > 30) {
            toggleStats();
            showToast('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ');
          }
        }, 2000);
      }
    }
    
    // ============ –ü–ï–†–ï–õ–Ü–¢ –î–û –£–ß–ê–°–ù–ò–ö–ê ============
    window.flyToParticipant = function(name) {
      const p = participants.find(p => p.name === name);
      if (p) {
        const coords = p.coords || { lat: 49.0, lng: 32.0 };
        map.flyTo([coords.lat, coords.lng], 8, { duration: 1.5 });
        
        setTimeout(() => {
          const marker = markers.find(m => {
            const popup = m.getPopup();
            return popup && popup.getContent().includes(p.name);
          });
          if (marker) marker.openPopup();
        }, 1500);
      }
    };
    
    // ============ –û–ù–û–í–õ–ï–ù–ù–Ø –ü–†–û–ì–†–ï–°–£ –†–ï–ì–Ü–û–ù–Ü–í ============
    function updateRegionProgress(regionCount) {
      const activeRegions = Object.keys(regionCount).length;
      document.getElementById('regionsActive').textContent = `${activeRegions}/14`;
      
      const progressPercent = (activeRegions / 14) * 100;
      document.getElementById('progressBar').style.width = progressPercent + '%';
      
      document.getElementById('celebrateBtn').style.display = activeRegions >= 14 ? 'flex' : 'none';
    }
    
    // ============ –ü–û–ö–ê–ó –°–ü–û–í–Ü–©–ï–ù–ù–Ø ============
    function showNewParticipantToast(participant) {
      showToast(`${participant.name} –∑ –º—ñ—Å—Ç–∞ ${participant.city} –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è! üå∏`);
    }
    
    function showToast(message) {
      const toast = document.getElementById('toastMessage');
      const toastText = document.getElementById('toastText');
      
      toastText.textContent = message;
      toast.style.display = 'flex';
      
      if (navigator.vibrate) navigator.vibrate(50);
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }
    
    // ============ –û–ù–û–í–õ–ï–ù–ù–Ø –ö–ê–†–¢–ò ============
    function refreshMap() {
      loadParticipants();
      showToast('–ö–∞—Ä—Ç—É –æ–Ω–æ–≤–ª–µ–Ω–æ! üåà');
    }
    
    // ============ –ü–†–ò–•–û–í–ê–¢–ò/–ü–û–ö–ê–ó–ê–¢–ò –°–¢–ê–¢–ò–°–¢–ò–ö–£ ============
    function toggleStats() {
      const panel = document.getElementById('statsPanel');
      const content = document.getElementById('statsContent');
      const btn = document.getElementById('toggleStatsBtn');
      
      if (statsVisible) {
        content.style.display = 'none';
        panel.style.minWidth = '60px';
        panel.style.padding = '12px';
        btn.innerHTML = 'üëÅÔ∏è‚Äçüó®Ô∏è';
        btn.title = '–ü–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É';
        statsVisible = false;
      } else {
        content.style.display = 'block';
        panel.style.minWidth = '260px';
        panel.style.padding = '16px';
        btn.innerHTML = 'üëÅÔ∏è';
        btn.title = '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É';
        statsVisible = true;
      }
    }
    
    // ============ –°–í–Ø–¢–ö–£–í–ê–ù–ù–Ø ============
    function showCelebration() {
      document.getElementById('celebrationOverlay').classList.add('active');
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
    }
    
    function hideCelebration() {
      document.getElementById('celebrationOverlay').classList.remove('active');
    }
    
    // ============ –ê–î–ú–Ü–ù-–§–£–ù–ö–¶–Ü–á ============
    function showAdminPanel() {
      document.getElementById('adminModal').style.display = 'flex';
      updateAdminStats();
    }
    
    function closeAdminPanel() {
      document.getElementById('adminModal').style.display = 'none';
    }
    
    function updateAdminStats() {
      const participants = JSON.parse(localStorage.getItem('pysanka_participants') || '[]');
      const emptyParticipants = participants.filter(p => 
        !p.city || p.city.trim() === '' || p.city === 'undefined' || p.city === 'null'
      );
      
      let statsHtml = `
        <p>–í—Å—å–æ–≥–æ –≤ localStorage: ${participants.length}</p>
        <p>–ü—É—Å—Ç–∏—Ö –∑–∞–ø–∏—Å—ñ–≤: ${emptyParticipants.length}</p>
      `;
      
      document.getElementById('adminStats').innerHTML = statsHtml;
      
      let emptyHtml = '';
      if (emptyParticipants.length > 0) {
        emptyHtml = '<h4 style="color:#ff9800; margin-top:10px;">–ü—É—Å—Ç—ñ —É—á–∞—Å–Ω–∏–∫–∏:</h4>';
        emptyParticipants.slice(0, 5).forEach((p, i) => {
          emptyHtml += `<p style="font-size:12px; margin:5px 0;">${i+1}. ID: ${p.id}, –Ü–º'—è: ${p.name || '?'}</p>`;
        });
        if (emptyParticipants.length > 5) {
          emptyHtml += `<p>... —Ç–∞ —â–µ ${emptyParticipants.length - 5}</p>`;
        }
      }
      
      document.getElementById('emptyParticipantsList').innerHTML = emptyHtml;
    }
    
    function quickCleanEmpty() {
      cleanEmptyParticipants();
    }
    
    function cleanEmptyParticipants() {
      if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤ –±–µ–∑ –º—ñ—Å—Ç–∞? –í–æ–Ω–∏ –∑–Ω–∏–∫–Ω—É—Ç—å –∑ –∫–∞—Ä—Ç–∏.')) return;
      
      try {
        const participants = JSON.parse(localStorage.getItem('pysanka_participants') || '[]');
        const validParticipants = participants.filter(p => 
          p.city && 
          p.city.trim() !== '' && 
          p.city !== 'undefined' && 
          p.city !== 'null'
        );
        
        localStorage.setItem('pysanka_participants', JSON.stringify(validParticipants));
        
        alert(`‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ ${participants.length - validParticipants.length} –ø—É—Å—Ç–∏—Ö –∑–∞–ø–∏—Å—ñ–≤`);
        
        closeAdminPanel();
        location.reload();
      } catch (e) {
        alert('–ü–æ–º–∏–ª–∫–∞: ' + e);
      }
    }
    
    async function syncWithGoogleSheets() {
      if (!confirm('–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∑ Google Sheets —Ç–∞ –æ–Ω–æ–≤–∏—Ç–∏ –ª–æ–∫–∞–ª—å–Ω—É –∫–∞—Ä—Ç—É?')) return;
      
      try {
        showToast('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è...');
        
        const response = await fetch(GOOGLE_SCRIPT_URL);
        const data = await response.json();
        
        if (data && data.length > 0) {
          const validData = data.filter(item => 
            item.city && 
            item.city.trim() !== '' && 
            item.name && 
            item.name.trim() !== ''
          );
          
          localStorage.setItem('pysanka_participants', JSON.stringify(validData));
          
          alert(`‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ${validData.length} —É—á–∞—Å–Ω–∏–∫—ñ–≤ –∑ Google Sheets`);
          closeAdminPanel();
          location.reload();
        } else {
          alert('‚ùå –ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –≤ Google Sheets');
        }
      } catch (e) {
        alert('–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó: ' + e);
      }
    }
    
    function resetLocalData() {
      if (confirm('‚ùì –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –ª–æ–∫–∞–ª—å–Ω—ñ –º–∞—Ä–∫–µ—Ä–∏? –ö–∞—Ä—Ç–∞ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è –∑ —Ç–∞–±–ª–∏—Ü—ñ –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ.')) {
        localStorage.removeItem('pysanka_participants');
        alert('‚úÖ –õ–æ–∫–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ –æ—á–∏—â–µ–Ω–æ');
        closeAdminPanel();
        location.reload();
      }
    }
    
    // ============ –ï–ö–°–ü–û–†–¢ –§–£–ù–ö–¶–Ü–ô ============
    window.refreshMap = refreshMap;
    window.showCelebration = showCelebration;
    window.hideCelebration = hideCelebration;
    window.toggleStats = toggleStats;
    window.flyToParticipant = flyToParticipant;
    window.showAdminPanel = showAdminPanel;
    window.closeAdminPanel = closeAdminPanel;
    window.cleanEmptyParticipants = cleanEmptyParticipants;
    window.quickCleanEmpty = quickCleanEmpty;
    window.syncWithGoogleSheets = syncWithGoogleSheets;
    window.resetLocalData = resetLocalData;
  </script>
</body>
</html>
