<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–°–æ–±–æ—Ä–Ω–∞ –ü–∏—Å–∞–Ω–∫–∞ | –ö–∞—Ä—Ç–∞ —î–¥–Ω–∞–Ω–Ω—è</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <style>
    /* ============ –°–¢–ò–õ–Ü (—Ç—ñ —Å–∞–º—ñ) ============ */
    :root {
      --bordo: #8B2C2C;
      --gold: #FFB347;
      --gold-light: #FFD966;
      --cream: #FFF9E6;
      --font-heading: 'Cormorant Garamond', serif;
      --font-body: 'Open Sans', sans-serif;
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: var(--font-body);
      background-color: var(--cream);
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
    }
    
    #map-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    
    #ukraine-map {
      width: 100%;
      height: 100%;
      background: #e8d9c0;
    }
    
    /* –ú–∞—Ä–∫–µ—Ä–∏ */
    .pysanka-marker {
      background: transparent;
      border: none;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
      transition: transform 0.2s ease;
      cursor: pointer;
    }
    
    .pysanka-egg {
      width: 44px;
      height: 62px;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      border: 2px solid white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      animation: gentleFloat 3s ease-in-out infinite;
    }
    
    @keyframes gentleFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    .pysanka-egg.rainbow-1 { background: linear-gradient(135deg, #FF6B6B, #FF8E8E); }
    .pysanka-egg.rainbow-2 { background: linear-gradient(135deg, #FFB347, #FFA07A); }
    .pysanka-egg.rainbow-3 { background: linear-gradient(135deg, #FFD93D, #FFE55C); }
    .pysanka-egg.rainbow-4 { background: linear-gradient(135deg, #6BCB77, #8FDC89); }
    .pysanka-egg.rainbow-5 { background: linear-gradient(135deg, #4D96FF, #6DABFF); }
    
    /* –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    .stats-panel {
      position: fixed;
      top: calc(10px + var(--safe-area-top));
      right: 10px;
      background: rgba(139, 44, 44, 0.95);
      backdrop-filter: blur(10px);
      border: 2px solid var(--gold);
      border-radius: 24px;
      padding: 16px;
      color: white;
      z-index: 100;
      min-width: 260px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    
    .stats-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .stats-title {
      font-family: var(--font-heading);
      font-size: 22px;
      color: var(--gold);
    }
    
    .toggle-stats-btn {
      background: transparent;
      border: 2px solid var(--gold);
      color: var(--gold);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
    }
    
    .stats-number {
      font-size: 44px;
      font-weight: 700;
      color: var(--gold);
      text-align: center;
    }
    
    .participants-list {
      max-height: 250px;
      overflow-y: auto;
      margin-top: 12px;
    }
    
    .participant-item {
      padding: 10px;
      border-bottom: 1px solid rgba(255, 179, 71, 0.3);
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }
    
    .participant-symbol {
      font-size: 22px;
      min-width: 36px;
    }
    
    .participant-name {
      color: var(--gold);
      font-weight: 600;
      flex: 1;
    }
    
    .participant-wish {
      font-size: 11px;
      color: var(--gold-light);
      font-style: italic;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* –ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è */
    .control-panel {
      position: fixed;
      bottom: calc(20px + var(--safe-area-bottom));
      right: 10px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .control-btn {
      padding: 12px 20px;
      background: var(--bordo);
      color: var(--gold);
      border: 2px solid var(--gold);
      border-radius: 40px;
      font-family: var(--font-heading);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      min-width: 140px;
      text-align: center;
    }
    
    .control-btn:active {
      background: var(--gold);
      color: var(--bordo);
      transform: scale(0.97);
    }
    
    /* –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è */
    .toast-message {
      position: fixed;
      top: calc(20px + var(--safe-area-top));
      left: 50%;
      transform: translateX(-50%);
      background: rgba(139, 44, 44, 0.98);
      border: 2px solid var(--gold);
      border-radius: 40px;
      padding: 14px 28px;
      color: white;
      z-index: 1000;
      display: none;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { transform: translate(-50%, -100%); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }
    
    @media (max-width: 768px) {
      .stats-panel {
        min-width: 220px;
      }
      .control-btn {
        min-width: 120px;
      }
    }
  </style>
</head>
<body>
  <div id="map-container">
    <div id="ukraine-map"></div>
  </div>
  
  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="stats-panel" id="statsPanel">
    <div class="stats-header">
      <div class="stats-title">üå∏ –ü–ò–°–ê–ù–ö–ê üå∏</div>
      <button class="toggle-stats-btn" onclick="toggleStats()" id="toggleStatsBtn">üëÅÔ∏è</button>
    </div>
    
    <div id="statsContent">
      <div class="stats-number" id="participantCount">0</div>
      <div class="stats-label">—É—á–∞—Å–Ω–∏–∫—ñ–≤</div>
      
      <div class="progress-container">
        <div class="progress-header">
          <span>14 —Ä–µ–≥—ñ–æ–Ω—ñ–≤</span>
          <span id="regionsActive">0/14</span>
        </div>
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" id="progressBar"></div>
        </div>
      </div>
      
      <div class="participants-list" id="participantsList">
        <div style="text-align: center; opacity: 0.5; padding: 20px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
      </div>
    </div>
  </div>
  
  <!-- –ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è -->
  <div class="control-panel">
    <button class="control-btn" onclick="refreshMap()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
    <button class="control-btn small" onclick="window.location.href='phase1.html'">ü•ö –ü–æ—á–∞—Ç–∏</button>
  </div>
  
  <!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
  <div class="toast-message" id="toastMessage">
    <span>üå∏</span>
    <span id="toastText">–ù–æ–≤–∏–π —É—á–∞—Å–Ω–∏–∫!</span>
  </div>
  
  <script>
    // ============ –ö–û–ù–§–Ü–ì ============
    const DASHBOARD_CONFIG = {
      SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbx5K0BYRggtszTnZh0-Hfw_JI7aoHqJBanzfs9x6bkvBpo5QMdJHJ2RzjnYbNsAJm1d/exec',
      TOKEN: '1680max',                     // <--- –í–ò–ü–†–ê–í–õ–ï–ù–û
      UPDATE_INTERVAL: 30000,               // 30 —Å–µ–∫—É–Ω–¥
      CACHE_KEY: 'pysanka_participants'
    };
    
    // ============ –ö–û–õ–¨–û–†–ò –¢–ê –°–ò–ú–í–û–õ–ò ============
    const RAINBOW_CLASSES = [
      'rainbow-1', 'rainbow-2', 'rainbow-3', 'rainbow-4', 'rainbow-5'
    ];
    
    const REGION_SYMBOLS = {
      1: 'üåª', 2: 'üå≤', 3: 'üèîÔ∏è', 4: 'üèõÔ∏è', 5: 'ü¶Å', 6: '‚öì', 7: '‚öôÔ∏è',
      8: 'üåä', 9: 'üåæ', 10: 'üìö', 11: 'üé≠', 12: 'üèñÔ∏è', 13: '‚õèÔ∏è', 14: 'üåª'
    };
    
    // ============ –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü ============
    let map;
    let markers = [];
    let participants = [];           // –∑–∞–≤–∂–¥–∏ –º—ñ—Å—Ç–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ (—Å–µ—Ä–≤–µ—Ä–Ω—ñ –∞–±–æ –ª–æ–∫–∞–ª—å–Ω—ñ)
    let statsVisible = true;
    let updateTimer = null;
    
    // ============ –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ============
    document.addEventListener('DOMContentLoaded', function() {
      initMap();
      loadInitialData();             // —Å–ø–æ—á–∞—Ç–∫—É –ª–æ–∫–∞–ª—å–Ω—ñ (—à–≤–∏–¥–∫–æ), –ø–æ—Ç—ñ–º —Å–µ—Ä–≤–µ—Ä–Ω—ñ
      startAutoUpdate();
    });
    
    function initMap() {
      map = L.map('ukraine-map', {
        zoomControl: false,
        attributionControl: false
      }).setView([49.0, 32.0], 6);
      
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 10,
        minZoom: 5
      }).addTo(map);
      
      if (window.innerWidth < 768) {
        L.control.zoom({ position: 'bottomleft' }).addTo(map);
      }
    }
    
    // ============ –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –î–ê–ù–ò–• ============
    async function loadInitialData() {
      // –°–ø–æ—á–∞—Ç–∫—É –ø–æ–∫–∞–∑—É—î–º–æ –ª–æ–∫–∞–ª—å–Ω—ñ (—è–∫—â–æ —î)
      loadLocalParticipants();
      // –ü–æ—Ç—ñ–º –ø—Ä–æ–±—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑ —Å–µ—Ä–≤–µ—Ä–∞ —ñ –æ–Ω–æ–≤–∏—Ç–∏ –∫–∞—Ä—Ç—É
      await fetchServerParticipants();
    }
    
    function loadLocalParticipants() {
      try {
        const saved = localStorage.getItem(DASHBOARD_CONFIG.CACHE_KEY);
        if (saved) {
          participants = JSON.parse(saved);
          updateMap();
          updateStats();
        }
      } catch (e) {
        console.log('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è localStorage');
      }
    }
    
    async function fetchServerParticipants() {
      try {
        const url = `${DASHBOARD_CONFIG.SCRIPT_URL}?token=${DASHBOARD_CONFIG.TOKEN}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success && data.data && data.data.participants) {
          // –°–µ—Ä–≤–µ—Ä–Ω—ñ –¥–∞–Ω—ñ
          const serverParticipants = data.data.participants;
          
          // –Ø–∫—â–æ participants —â–µ –Ω–µ –º–∞—î –¥–∞–Ω–∏—Ö, –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—Å–≤–æ—é—î–º–æ
          if (!participants.length) {
            participants = serverParticipants;
          } else {
            // –û–±'—î–¥–Ω—É—î–º–æ: –¥–æ–¥–∞—î–º–æ —Ç–∏—Ö, –∫–æ–≥–æ –Ω–µ–º–∞—î –≤ –ø–æ—Ç–æ—á–Ω–æ–º—É –º–∞—Å–∏–≤—ñ (–∑–∞ ID)
            const existingIds = new Set(participants.map(p => p.id));
            const newFromServer = serverParticipants.filter(p => !existingIds.has(p.id));
            participants = [...participants, ...newFromServer];
          }
          
          updateMap();
          updateStats();
          showToast(`üîÑ –û–Ω–æ–≤–ª–µ–Ω–æ: ${participants.length} —É—á–∞—Å–Ω–∏–∫—ñ–≤`);
        } else {
          console.log('–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É:', data.error);
          showToast('‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–∞', 2000);
        }
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º:', error);
        showToast('‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, –ø–æ–∫–∞–∑—É—é –ª–æ–∫–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ', 2000);
      }
    }
    
    // ============ –ê–í–¢–û–ú–ê–¢–ò–ß–ù–ï –û–ù–û–í–õ–ï–ù–ù–Ø ============
    function startAutoUpdate() {
      if (updateTimer) clearInterval(updateTimer);
      updateTimer = setInterval(() => {
        if (!document.hidden) fetchServerParticipants();
      }, DASHBOARD_CONFIG.UPDATE_INTERVAL);
    }
    
    // ============ –û–ù–û–í–õ–ï–ù–ù–Ø –ö–ê–†–¢–ò ============
    function updateMap() {
      // –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä—ñ –º–∞—Ä–∫–µ—Ä–∏
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      
      if (!participants || participants.length === 0) return;
      
      const regionCount = {};
      
      participants.forEach((p, index) => {
        const coords = p.coords || { lat: 49.0, lng: 32.0 };
        const regionId = p.regionId;
        
        if (regionId) regionCount[regionId] = (regionCount[regionId] || 0) + 1;
        
        const colorClass = RAINBOW_CLASSES[index % RAINBOW_CLASSES.length];
        const marker = createMarker(p, coords.lat, coords.lng, colorClass);
        marker.addTo(map);
        markers.push(marker);
      });
      
      updateRegionProgress(regionCount);
    }
    
    function createMarker(participant, lat, lng, colorClass) {
      const symbol = participant.symbol || 'ü•ö';
      const wish = participant.wish || '–•—Ä–∏—Å—Ç–æ—Å –í–æ—Å–∫—Ä–µ—Å!';
      
      const markerHtml = `
        <div class="pysanka-marker" title="${participant.name}">
          <div class="pysanka-egg ${colorClass}">${symbol}</div>
        </div>
      `;
      
      const icon = L.divIcon({
        className: '',
        html: markerHtml,
        iconSize: [44, 62],
        iconAnchor: [22, 31]
      });
      
      const marker = L.marker([lat, lng], { icon: icon });
      
      const diasporaText = participant.isDiaspora ? '<br><small>üá∫üá¶ –°–µ—Ä—Ü–µ –∑ –£–∫—Ä–∞—ó–Ω–æ—é</small>' : '';
      
      marker.bindPopup(`
        <div style="text-align: center; min-width: 160px;">
          <div style="font-size: 28px;">${symbol}</div>
          <b style="color: #8B2C2C;">${participant.name}</b><br>
          <i style="color: #FFB347;">${participant.city}</i><br>
          <small style="color: #666; font-style: italic;">"${wish}"</small>
          ${diasporaText}
        </div>
      `);
      
      return marker;
    }
    
    // ============ –°–¢–ê–¢–ò–°–¢–ò–ö–ê ============
    function updateStats() {
      const count = participants.length;
      document.getElementById('participantCount').textContent = count;
      
      const listEl = document.getElementById('participantsList');
      
      if (count === 0) {
        listEl.innerHTML = '<div style="text-align: center; padding: 20px;">–ß–µ–∫–∞—î–º–æ...</div>';
        return;
      }
      
      const recent = [...participants].reverse().slice(0, 8);
      
      listEl.innerHTML = recent.map((p, i) => {
        const wish = p.wish || '–•—Ä–∏—Å—Ç–æ—Å –í–æ—Å–∫—Ä–µ—Å!';
        const shortWish = wish.length > 30 ? wish.substr(0, 27) + '...' : wish;
        
        return `
          <div class="participant-item" onclick="flyToParticipant('${p.name.replace(/'/g, "\\'")}')">
            <span class="participant-symbol">${p.symbol || 'ü•ö'}</span>
            <span class="participant-name">${p.name}</span>
            <span class="participant-wish" title="${wish}">"${shortWish}"</span>
          </div>
        `;
      }).join('');
    }
    
    function updateRegionProgress(regionCount) {
      const active = Object.keys(regionCount).length;
      document.getElementById('regionsActive').textContent = `${active}/14`;
      document.getElementById('progressBar').style.width = (active / 14 * 100) + '%';
    }
    
    // ============ –§–£–ù–ö–¶–Ü–á –ö–ï–†–£–í–ê–ù–ù–Ø ============
    window.flyToParticipant = function(name) {
      const p = participants.find(p => p.name === name);
      if (p) {
        const coords = p.coords || { lat: 49.0, lng: 32.0 };
        map.flyTo([coords.lat, coords.lng], 8, { duration: 1.5 });
        
        setTimeout(() => {
          const marker = markers.find(m => {
            const popup = m.getPopup();
            return popup && popup.getContent().includes(p.name);
          });
          if (marker) marker.openPopup();
        }, 1500);
      }
    };
    
    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toastMessage');
      document.getElementById('toastText').textContent = message;
      toast.style.display = 'flex';
      
      if (navigator.vibrate) navigator.vibrate(50);
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, duration);
    }
    
    function refreshMap() {
      fetchServerParticipants();
    }
    
    function toggleStats() {
      const panel = document.getElementById('statsPanel');
      const content = document.getElementById('statsContent');
      const btn = document.getElementById('toggleStatsBtn');
      
      if (statsVisible) {
        content.style.display = 'none';
        panel.style.minWidth = '60px';
        btn.innerHTML = 'üëÅÔ∏è‚Äçüó®Ô∏è';
        statsVisible = false;
      } else {
        content.style.display = 'block';
        panel.style.minWidth = '260px';
        btn.innerHTML = 'üëÅÔ∏è';
        statsVisible = true;
      }
    }
    
    // ============ –ï–ö–°–ü–û–†–¢ –§–£–ù–ö–¶–Ü–ô ============
    window.refreshMap = refreshMap;
    window.toggleStats = toggleStats;
  </script>
</body>
</html>
