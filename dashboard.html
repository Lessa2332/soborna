<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–°–æ–±–æ—Ä–Ω–∞ –ü–∏—Å–∞–Ω–∫–∞ | –ö–∞—Ä—Ç–∞ —î–¥–Ω–∞–Ω–Ω—è</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="css/pysanka-theme.css">
  <style>
    /* –£–Ω—ñ–∫–∞–ª—å–Ω—ñ —Å—Ç–∏–ª—ñ –¥–ª—è dashboard */
    body {
      background-color: var(--magic-purple);
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
    }
    #map-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #ukraine-map {
      width: 100%;
      height: 100%;
      background: #2b003e; /* —Ç–µ–º–Ω–æ-—Ñ—ñ–æ–ª–µ—Ç–æ–≤–∏–π —Ñ–æ–Ω –¥–ª—è –∫–∞—Ä—Ç–∏ */
    }
    .pysanka-marker {
      background: transparent;
      border: none;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
      transition: transform 0.2s ease;
      cursor: pointer;
    }
    .pysanka-egg {
      width: 44px;
      height: 62px;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      border: 2px solid var(--gold-magic);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      animation: gentleFloat 3s ease-in-out infinite;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      color: var(--gold-light);
      text-shadow: 0 1px 2px #000;
    }
    @keyframes gentleFloat {
      0%,100%{transform:translateY(0);}
      50%{transform:translateY(-5px);}
    }
    /* –ö–æ–ª—å–æ—Ä–∏ –º–∞—Ä–∫–µ—Ä—ñ–≤ –∑–∞ —Ä–µ–≥—ñ–æ–Ω–∞–º–∏ (–º–æ–∂–Ω–∞ —Ä–æ–∑—à–∏—Ä–∏—Ç–∏) */
    .pysanka-egg.region-1 { background: linear-gradient(135deg, #8B0000, #A52A2A); }
    .pysanka-egg.region-2 { background: linear-gradient(135deg, #006400, #228B22); }
    .pysanka-egg.region-3 { background: linear-gradient(135deg, #4A7023, #6B8E23); }
    .pysanka-egg.region-4 { background: linear-gradient(135deg, #8B0000, #B22222); }
    .pysanka-egg.region-5 { background: linear-gradient(135deg, #DAA520, #B8860B); }
    .pysanka-egg.region-6 { background: linear-gradient(135deg, #1E90FF, #4682B4); }
    .pysanka-egg.region-7 { background: linear-gradient(135deg, #B22222, #CD5C5C); }
    .pysanka-egg.region-8 { background: linear-gradient(135deg, #2E8B57, #3CB371); }
    .pysanka-egg.region-9 { background: linear-gradient(135deg, #DAA520, #F4A460); }
    .pysanka-egg.region-10 { background: linear-gradient(135deg, #8B4513, #A0522D); }
    .pysanka-egg.region-11 { background: linear-gradient(135deg, #CD5C5C, #B22222); }
    .pysanka-egg.region-12 { background: linear-gradient(135deg, #F4A460, #DEB887); }
    .pysanka-egg.region-13 { background: linear-gradient(135deg, #696969, #808080); }
    .pysanka-egg.region-14 { background: linear-gradient(135deg, #9ACD32, #6B8E23); }
    .pysanka-egg.diaspora { background: linear-gradient(135deg, #D4AF37, #FFD700); border-color: #8B0000; }

    .stats-panel {
      position: fixed;
      top: calc(10px + env(safe-area-inset-top));
      right: 10px;
      background: rgba(42,0,62,0.9);
      backdrop-filter: blur(10px);
      border: 3px solid var(--gold-magic);
      border-radius: 30px;
      padding: 18px;
      color: var(--gold-light);
      z-index: 100;
      min-width: 260px;
      box-shadow: var(--shadow-lg);
    }
    .stats-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      border-bottom: 2px solid var(--gold-magic);
      padding-bottom: 8px;
    }
    .stats-title {
      font-family: var(--font-heading);
      font-size: 24px;
      color: var(--gold-magic);
      letter-spacing: 2px;
    }
    .toggle-stats-btn {
      background: transparent;
      border: 2px solid var(--gold-magic);
      color: var(--gold-magic);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .stats-number {
      font-size: 48px;
      font-weight: 700;
      color: var(--gold-magic);
      text-align: center;
      line-height: 1.2;
    }
    .stats-label {
      text-align: center;
      font-size: 16px;
      color: var(--gold-light);
      margin-bottom: 12px;
    }
    .progress-container {
      margin: 16px 0;
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: var(--gold-light);
      margin-bottom: 4px;
    }
    .progress-bar-bg {
      height: 8px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--gold-magic), var(--gold-light));
      transition: width 0.3s ease;
    }
    .participants-list {
      max-height: 250px;
      overflow-y: auto;
      margin-top: 12px;
      border-top: 1px solid rgba(212,175,55,0.3);
      padding-top: 8px;
    }
    .participant-item {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: background 0.2s;
      border-radius: 20px;
      color: var(--gold-light);
    }
    .participant-item:hover {
      background: rgba(212,175,55,0.2);
    }
    .participant-symbol {
      font-size: 24px;
      min-width: 36px;
      text-align: center;
    }
    .participant-name {
      color: var(--gold-magic);
      font-weight: 600;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .participant-wish {
      font-size: 11px;
      color: var(--gold-light);
      font-style: italic;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .control-panel {
      position: fixed;
      bottom: calc(20px + env(safe-area-inset-bottom));
      right: 10px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .control-btn {
      padding: 12px 20px;
      background: var(--magic-purple-light);
      color: var(--gold-light);
      border: 2px solid var(--gold-magic);
      border-radius: 40px;
      font-family: var(--font-heading);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      min-width: 140px;
      text-align: center;
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }
    .control-btn:active {
      background: var(--gold-magic);
      color: var(--magic-purple-dark);
      transform: scale(0.97);
    }
    .toast-message {
      position: fixed;
      top: calc(20px + env(safe-area-inset-top));
      left: 50%;
      transform: translateX(-50%);
      background: rgba(42,0,62,0.98);
      border: 2px solid var(--gold-magic);
      border-radius: 40px;
      padding: 14px 28px;
      color: white;
      z-index: 1000;
      display: none;
      animation: slideDown 0.3s ease;
      font-size: 18px;
      white-space: nowrap;
    }
    @keyframes slideDown {
      from { transform: translate(-50%, -100%); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }
    @media (max-width:768px){
      .stats-panel{min-width:220px;}
      .control-btn{min-width:120px; font-size:14px; padding:10px 16px;}
    }
  </style>
</head>
<body>
  <div id="map-container"><div id="ukraine-map"></div></div>

  <div class="stats-panel" id="statsPanel">
    <div class="stats-header">
      <div class="stats-title">–°–û–ë–û–†–ù–ê –ü–ò–°–ê–ù–ö–ê</div>
      <button class="toggle-stats-btn" onclick="toggleStats()" id="toggleStatsBtn">üëÅÔ∏è</button>
    </div>
    <div id="statsContent">
      <div class="stats-number" id="participantCount">0</div>
      <div class="stats-label">—É—á–∞—Å–Ω–∏–∫—ñ–≤</div>
      <div class="progress-container">
        <div class="progress-header"><span>14 —Ä–µ–≥—ñ–æ–Ω—ñ–≤</span><span id="regionsActive">0/14</span></div>
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressBar"></div></div>
      </div>
      <div class="participants-list" id="participantsList"><div style="text-align:center; opacity:0.7; padding:20px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>
    </div>
  </div>

  <div class="control-panel">
    <button class="control-btn" onclick="refreshMap()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
    <button class="control-btn" onclick="window.location.href='phase1.html'">ü•ö –ü–æ—á–∞—Ç–∏</button>
  </div>

  <div class="toast-message" id="toastMessage"><span>üå∏</span><span id="toastText">–ù–æ–≤–∏–π —É—á–∞—Å–Ω–∏–∫!</span></div>

  <script>
    const DASHBOARD_CONFIG = {
      SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxUZJ96jzhDBAiVMfFOU520qB99wlB21IyoN1mXIOhrwRfCdaCRJ8xtP5TR2tWz6V6g/exec',
      TOKEN: '1680max',
      UPDATE_INTERVAL: 30000,
      CACHE_KEY: 'pysanka_participants'
    };

    const REGION_SYMBOLS = {
      1:'üåª',2:'üå≤',3:'üèîÔ∏è',4:'üèõÔ∏è',5:'ü¶Å',6:'‚öì',7:'‚öôÔ∏è',
      8:'üåä',9:'üåæ',10:'üìö',11:'üé≠',12:'üèñÔ∏è',13:'‚õèÔ∏è',14:'üåª'
    };

    let map, markers = [], participants = [], statsVisible = true, updateTimer = null;

    document.addEventListener('DOMContentLoaded', ()=>{
      initMap();
      loadInitialData();
      startAutoUpdate();
    });

    function initMap() {
      map = L.map('ukraine-map', { zoomControl: false, attributionControl: false }).setView([49.0, 32.0], 6);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom:10, minZoom:5 }).addTo(map);
      if (window.innerWidth < 768) L.control.zoom({ position:'bottomleft' }).addTo(map);
    }

    async function loadInitialData() {
      loadLocalParticipants();
      await fetchServerParticipants();
    }

    function loadLocalParticipants() {
      try {
        const saved = localStorage.getItem(DASHBOARD_CONFIG.CACHE_KEY);
        if (saved) {
          participants = JSON.parse(saved);
          updateMap();
          updateStats();
        }
      } catch(e){ console.log('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è localStorage'); }
    }

    async function fetchServerParticipants() {
      try {
        const url = `${DASHBOARD_CONFIG.SCRIPT_URL}?token=${DASHBOARD_CONFIG.TOKEN}`;
        const response = await fetch(url);
        const data = await response.json();
        if (data.success && data.data && data.data.participants) {
          const serverParticipants = data.data.participants.map(p => ({
            // –ú–∞–ø–ø—ñ–Ω–≥ –ø–æ–ª—ñ–≤ –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å–µ—Ä–≤–µ—Ä–∞ (–æ—á—ñ–∫—É—î–º–æ –∞–Ω–≥–ª—ñ–π—Å—å–∫—ñ –Ω–∞–∑–≤–∏)
            id: p.ID || p.id || Date.now(),
            name: p.user_name || p["–Ü–º'—è"] || '–£—á–∞—Å–Ω–∏–∫',
            wish: p.user_wish || p["–ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è"] || '',
            city: p.city || p["–ú—ñ—Å—Ç–æ (–≤–≤–µ–¥–µ–Ω–µ)"] || '',
            region: p.region_name || p["–†–µ–≥—ñ–æ–Ω"] || '',
            regionId: p.region_id || p.RegionID || 0,
            timestamp: p.timestamp || p.Timestamp,
            coords: {
              lat: parseFloat(p.lat || p.Latitude) || 49.0,
              lng: parseFloat(p.lng || p.Longitude) || 32.0
            },
            symbol: REGION_SYMBOLS[p.region_id] || 'ü•ö'
          }));

          // –û–±'—î–¥–Ω—É—î–º–æ –∑ –ª–æ–∫–∞–ª—å–Ω–∏–º–∏ (—É–Ω—ñ–∫–∞–ª—å–Ω—ñ –∑–∞ id)
          const existingIds = new Set(participants.map(p => p.id));
          const newFromServer = serverParticipants.filter(p => !existingIds.has(p.id));
          participants = [...participants, ...newFromServer];

          updateMap();
          updateStats();
          showToast(`üîÑ –û–Ω–æ–≤–ª–µ–Ω–æ: ${participants.length} —É—á–∞—Å–Ω–∏–∫—ñ–≤`);
        } else {
          console.log('–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É:', data.error);
          showToast('‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–∞', 2000);
        }
      } catch(error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º:", error);
        showToast('‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, –ø–æ–∫–∞–∑—É—é –ª–æ–∫–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ', 2000);
      }
    }

    function startAutoUpdate() {
      if (updateTimer) clearInterval(updateTimer);
      updateTimer = setInterval(() => { if (!document.hidden) fetchServerParticipants(); }, DASHBOARD_CONFIG.UPDATE_INTERVAL);
    }

    function updateMap() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      if (!participants.length) return;

      const regionCount = {};
      participants.forEach(p => {
        const regionId = p.regionId;
        if (regionId) regionCount[regionId] = (regionCount[regionId]||0)+1;
        let regionClass = 'diaspora';
        if (regionId && regionId>=1 && regionId<=14) regionClass = `region-${regionId}`;
        const marker = createMarker(p, p.coords.lat, p.coords.lng, regionClass);
        marker.addTo(map);
        markers.push(marker);
      });
      updateRegionProgress(regionCount);
    }

    function createMarker(p, lat, lng, regionClass) {
      const symbol = p.symbol || 'ü•ö';
      const wish = p.wish || '';
      const icon = L.divIcon({
        className: '',
        html: `<div class="pysanka-marker" title="${p.name}"><div class="pysanka-egg ${regionClass}">${symbol}</div></div>`,
        iconSize: [44,62],
        iconAnchor: [22,31]
      });
      const marker = L.marker([lat,lng], { icon });
      marker.bindPopup(`
        <div style="text-align:center; min-width:160px; font-family:'Open Sans',sans-serif;">
          <div style="font-size:28px;">${symbol}</div>
          <b style="color:#8B0000;">${p.name}</b><br>
          <i style="color:#D4AF37;">${p.city}</i><br>
          ${wish ? `<small style="color:#666; font-style:italic;">"${wish}"</small><br>` : ''}
          <small style="color:#D4AF37;">${p.region}</small>
        </div>
      `);
      return marker;
    }

    function updateStats() {
      const count = participants.length;
      document.getElementById('participantCount').textContent = count;
      const listEl = document.getElementById('participantsList');
      if (count===0) {
        listEl.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.7;">–ß–µ–∫–∞—î–º–æ –Ω–∞ –ø–µ—Ä—à–∏—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤...</div>';
        return;
      }
      const recent = [...participants].reverse().slice(0,8);
      listEl.innerHTML = recent.map(p => {
        const wish = p.wish || '';
        const shortWish = wish.length>30 ? wish.substr(0,27)+'‚Ä¶' : wish;
        const symbol = p.symbol || 'ü•ö';
        const escapedName = p.name.replace(/'/g, "\\'");
        return `
          <div class="participant-item" onclick="flyToParticipant('${escapedName}')">
            <span class="participant-symbol">${symbol}</span>
            <span class="participant-name">${p.name}</span>
            <span class="participant-wish" title="${wish}">${wish ? '"'+shortWish+'"' : ''}</span>
          </div>
        `;
      }).join('');
    }

    function updateRegionProgress(regionCount) {
      const active = Object.keys(regionCount).length;
      document.getElementById('regionsActive').textContent = `${active}/14`;
      document.getElementById('progressBar').style.width = (active/14*100)+'%';
    }

    window.flyToParticipant = function(name) {
      const p = participants.find(p => p.name === name);
      if (p) {
        map.flyTo([p.coords.lat, p.coords.lng], 8, { duration:1.5 });
        setTimeout(() => {
          const marker = markers.find(m => m.getPopup()?.getContent().includes(p.name));
          if (marker) marker.openPopup();
        }, 1500);
      }
    };

    function showToast(msg, dur=3000) {
      const toast = document.getElementById('toastMessage');
      document.getElementById('toastText').textContent = msg;
      toast.style.display = 'flex';
      if (navigator.vibrate) navigator.vibrate(50);
      setTimeout(()=>toast.style.display='none', dur);
    }

    function refreshMap() { fetchServerParticipants(); }
    function toggleStats() {
      const panel = document.getElementById('statsPanel'), content = document.getElementById('statsContent'), btn = document.getElementById('toggleStatsBtn');
      if (statsVisible) {
        content.style.display='none';
        panel.style.minWidth='60px';
        btn.innerHTML='üëÅÔ∏è‚Äçüó®Ô∏è';
        statsVisible=false;
      } else {
        content.style.display='block';
        panel.style.minWidth='260px';
        btn.innerHTML='üëÅÔ∏è';
        statsVisible=true;
      }
    }
    window.refreshMap = refreshMap;
    window.toggleStats = toggleStats;
  </script>
</body>
</html>

