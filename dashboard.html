<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–°–æ–±–æ—Ä–Ω–∞ –ü–∏—Å–∞–Ω–∫–∞ | –ö–∞—Ä—Ç–∞ —î–¥–Ω–∞–Ω–Ω—è</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* –≤–∞—à—ñ —Å—Ç–∏–ª—ñ (–±–µ–∑ –∑–º—ñ–Ω) */
  </style>
</head>
<body>
  <div id="map-container"><div id="ukraine-map"></div></div>

  <div class="stats-panel" id="statsPanel">
    <div class="stats-header">
      <div class="stats-title">–°–û–ë–û–†–ù–ê –ü–ò–°–ê–ù–ö–ê</div>
      <button class="toggle-stats-btn" onclick="toggleStats()" id="toggleStatsBtn" title="–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É">üëÅÔ∏è</button>
    </div>
    <div id="statsContent">
      <div class="stats-number" id="participantCount">0</div>
      <div class="stats-label">—É—á–∞—Å–Ω–∏–∫—ñ–≤</div>
      <div class="progress-container">
        <div class="progress-header"><span>14 —Ä–µ–≥—ñ–æ–Ω—ñ–≤</span><span id="regionsActive">0/14</span></div>
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressBar"></div></div>
      </div>
      <div class="participants-list" id="participantsList"><div style="text-align:center; opacity:0.7; padding:20px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>
    </div>
  </div>

  <div class="control-panel">
    <button class="control-btn" onclick="refreshMap()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
    <button class="control-btn" onclick="window.location.href='phase1.html'">ü•ö –ü–æ—á–∞—Ç–∏</button>
  </div>

  <div class="toast-message" id="toastMessage"><span>üå∏</span><span id="toastText">–ù–æ–≤–∏–π —É—á–∞—Å–Ω–∏–∫!</span></div>

  <script>
    // ============ –ù–û–í–ò–ô URL –í–ê–®–û–ì–û GOOGLE APPS SCRIPT ============
    const DASHBOARD_CONFIG = {
      SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzTiw1e9oT1ld1rh6wJXpt2CKvZrigIc0DDGrX_FmfDLZ1u-VdlzIGKVzpV6uY0BYNW/exec',
      TOKEN: '1680max',
      UPDATE_INTERVAL: 30000,
      CACHE_KEY: 'pysanka_participants'
    };

    // ============ –°–ò–ú–í–û–õ–ò –†–ï–ì–Ü–û–ù–Ü–í ============
    const REGION_SYMBOLS = {
      1:'üåª',2:'üå≤',3:'üèîÔ∏è',4:'üèõÔ∏è',5:'ü¶Å',6:'‚öì',7:'‚öôÔ∏è',
      8:'üåä',9:'üåæ',10:'üìö',11:'üé≠',12:'üèñÔ∏è',13:'‚õèÔ∏è',14:'üåª'
    };

    let map;
    let markers = [];
    let participants = [];
    let statsVisible = true;
    let updateTimer = null;

    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      loadInitialData();
      startAutoUpdate();
    });

    function initMap() {
      map = L.map('ukraine-map', {
        zoomControl: false,
        attributionControl: false
      }).setView([49.0, 32.0], 6);

      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 10,
        minZoom: 5
      }).addTo(map);

      if (window.innerWidth < 768) {
        L.control.zoom({ position: 'bottomleft' }).addTo(map);
      }
    }

    async function loadInitialData() {
      loadLocalParticipants();
      await fetchServerParticipants();
    }

    function loadLocalParticipants() {
      try {
        const saved = localStorage.getItem(DASHBOARD_CONFIG.CACHE_KEY);
        if (saved) {
          participants = JSON.parse(saved);
          updateMap();
          updateStats();
        }
      } catch(e) {
        console.log('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è localStorage:', e);
      }
    }

    // ============ –û–ù–û–í–õ–ï–ù–ê –§–£–ù–ö–¶–Ü–Ø –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –ó –°–ï–†–í–ï–†–ê ============
    async function fetchServerParticipants() {
      try {
        const url = `${DASHBOARD_CONFIG.SCRIPT_URL}?token=${DASHBOARD_CONFIG.TOKEN}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.success && result.data && Array.isArray(result.data.participants)) {
          const serverData = result.data.participants;

          // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –¥–∞–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–∞ —É –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Ñ–æ—Ä–º–∞—Ç (–Ω–æ–≤—ñ –ø–æ–ª—è)
          const serverParticipants = serverData.map(item => ({
            id: item.ID || 'pysanka_' + Date.now() + Math.random(),
            name: item.userName || '–£—á–∞—Å–Ω–∏–∫',
            wish: item.userWish || '',
            ancestorCity: item.ancestorCity || '',          // –Ω–æ–≤–µ –ø–æ–ª–µ
            currentLocation: item.currentLocation || '',      // –Ω–æ–≤–µ –ø–æ–ª–µ
            region: item.regionName || '',
            regionId: item.regionId ? parseInt(item.regionId) : null,
            country: item.country || '–£–∫—Ä–∞—ó–Ω–∞',
            timestamp: item.Timestamp || new Date().toISOString(),
            coords: {
              lat: parseFloat(item.lat) || 49.0,
              lng: parseFloat(item.lng) || 32.0
            },
            isDiaspora: item.isDiaspora === '–¢–∞–∫' || item.isDiaspora === true,
            symbol: REGION_SYMBOLS[item.regionId] || (item.isDiaspora ? 'üåç' : 'ü•ö')
          }));

          // –û–±'—î–¥–Ω—É—î–º–æ –∑ –ª–æ–∫–∞–ª—å–Ω–∏–º–∏, —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –∑–∞ ID
          const existingIds = new Set(participants.map(p => p.id));
          const newFromServer = serverParticipants.filter(p => !existingIds.has(p.id));

          if (newFromServer.length > 0) {
            participants = [...participants, ...newFromServer];
            localStorage.setItem(DASHBOARD_CONFIG.CACHE_KEY, JSON.stringify(participants));
            updateMap();
            updateStats();

            if (newFromServer.length === 1) {
              showToast(`‚ú® –ù–æ–≤–∏–π —É—á–∞—Å–Ω–∏–∫: ${newFromServer[0].name} –∑ –º—ñ—Å—Ç–∞ ${newFromServer[0].ancestorCity}`);
            } else {
              showToast(`üîÑ –î–æ–¥–∞–Ω–æ ${newFromServer.length} –Ω–æ–≤–∏—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤`);
            }
          } else {
            showToast('‚úÖ –î–∞–Ω—ñ –∞–∫—Ç—É–∞–ª—å–Ω—ñ');
          }
        } else {
          console.log('–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É:', result.error);
          showToast('‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–∞', 2000);
        }
      } catch(error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º:", error);
        showToast('‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, –ø–æ–∫–∞–∑—É—é –ª–æ–∫–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ', 2000);
      }
    }

    function startAutoUpdate() {
      if (updateTimer) clearInterval(updateTimer);
      updateTimer = setInterval(() => {
        if (!document.hidden) fetchServerParticipants();
      }, DASHBOARD_CONFIG.UPDATE_INTERVAL);
    }

    function updateMap() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      if (!participants.length) return;

      const regionCount = {};

      participants.forEach(p => {
        const regionId = p.regionId;
        if (regionId && regionId >= 1 && regionId <= 14) {
          regionCount[regionId] = (regionCount[regionId] || 0) + 1;
        }

        let regionClass = 'diaspora';
        if (regionId && regionId >= 1 && regionId <= 14) {
          regionClass = `region-${regionId}`;
        } else if (!p.isDiaspora && !regionId) {
          regionClass = 'region-4';
        }

        const marker = createMarker(p, p.coords.lat, p.coords.lng, regionClass);
        marker.addTo(map);
        markers.push(marker);
      });

      updateRegionProgress(regionCount);
    }

    // ============ –û–ù–û–í–õ–ï–ù–ê –§–£–ù–ö–¶–Ü–Ø –°–¢–í–û–†–ï–ù–ù–Ø –ú–ê–†–ö–ï–†–ê ============
    function createMarker(participant, lat, lng, regionClass) {
      const symbol = participant.symbol || 'ü•ö';
      const wish = participant.wish || '';
      const ancestorCity = participant.ancestorCity || '';
      const currentLocation = participant.currentLocation || '';

      const icon = L.divIcon({
        className: '',
        html: `<div class="pysanka-marker" title="${participant.name}">
                 <div class="pysanka-egg ${regionClass}">${symbol}</div>
               </div>`,
        iconSize: [44, 62],
        iconAnchor: [22, 31]
      });

      const marker = L.marker([lat, lng], { icon });

      let popupContent = `
        <div style="text-align:center; min-width:160px; font-family:'Open Sans',sans-serif;">
          <div style="font-size:28px; margin-bottom:5px;">${symbol}</div>
          <b style="color:#8B0000; font-size:16px;">${participant.name}</b><br>
          <i style="color:#D4AF37;">${ancestorCity || '–ú—ñ—Å—Ç–æ –ø—Ä–µ–¥–∫—ñ–≤'}</i>
      `;
      if (currentLocation) {
        popupContent += `<br><small style="color:#aaa;">üìç ${currentLocation}</small>`;
      }
      if (participant.country && participant.country !== '–£–∫—Ä–∞—ó–Ω–∞') {
        popupContent += `<br><small>${participant.country}</small>`;
      }
      if (wish) {
        popupContent += `<br><small style="color:#666; font-style:italic;">"${wish}"</small>`;
      }
      if (participant.isDiaspora) {
        popupContent += `<br><small style="color:#ff9800;">üá∫üá¶ –°–µ—Ä—Ü–µ –∑ –£–∫—Ä–∞—ó–Ω–æ—é</small>`;
      }
      popupContent += `</div>`;

      marker.bindPopup(popupContent, {
        className: 'custom-popup',
        closeButton: false
      });

      return marker;
    }

    // ============ –û–ù–û–í–õ–ï–ù–ê –§–£–ù–ö–¶–Ü–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò ============
    function updateStats() {
      const count = participants.length;
      document.getElementById('participantCount').textContent = count;

      const listEl = document.getElementById('participantsList');

      if (count === 0) {
        listEl.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.7;">–ß–µ–∫–∞—î–º–æ –Ω–∞ –ø–µ—Ä—à–∏—Ö —É—á–∞—Å–Ω–∏–∫—ñ–≤...</div>';
        return;
      }

      const recent = [...participants].reverse().slice(0, 8);

      listEl.innerHTML = recent.map(p => {
        const wish = p.wish || '';
        const shortWish = wish.length > 30 ? wish.substr(0, 27) + '‚Ä¶' : wish;
        const symbol = p.symbol || 'ü•ö';
        const escapedName = p.name.replace(/'/g, "\\'");
        // –ü–æ–∫–∞–∑—É—î–º–æ –º—ñ—Å—Ç–æ –ø—Ä–µ–¥–∫—ñ–≤ –∑–∞–º—ñ—Å—Ç—å —Å—Ç–∞—Ä–æ–≥–æ city
        const displayCity = p.ancestorCity || '';
        return `
          <div class="participant-item" onclick="flyToParticipant('${escapedName}')">
            <span class="participant-symbol">${symbol}</span>
            <span class="participant-name">${p.name}</span>
            ${displayCity ? `<span class="participant-wish" title="${displayCity}">${displayCity}</span>` : ''}
          </div>
        `;
      }).join('');
    }

    function updateRegionProgress(regionCount) {
      const activeRegions = Object.keys(regionCount).length;
      document.getElementById('regionsActive').textContent = `${activeRegions}/14`;
      const percent = (activeRegions / 14) * 100;
      document.getElementById('progressBar').style.width = percent + '%';
    }

    window.flyToParticipant = function(name) {
      const participant = participants.find(p => p.name === name);
      if (!participant) return;

      map.flyTo([participant.coords.lat, participant.coords.lng], 8, { duration: 1.5 });

      setTimeout(() => {
        const marker = markers.find(m => {
          const popup = m.getPopup();
          return popup && popup.getContent().includes(participant.name);
        });
        if (marker) marker.openPopup();
      }, 1500);
    };

    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toastMessage');
      const toastText = document.getElementById('toastText');
      toastText.textContent = message;
      toast.style.display = 'flex';

      if (navigator.vibrate) navigator.vibrate(50);

      setTimeout(() => {
        toast.style.display = 'none';
      }, duration);
    }

    function refreshMap() {
      fetchServerParticipants();
    }

    function toggleStats() {
      const panel = document.getElementById('statsPanel');
      const content = document.getElementById('statsContent');
      const btn = document.getElementById('toggleStatsBtn');

      if (statsVisible) {
        content.style.display = 'none';
        panel.style.minWidth = '60px';
        panel.style.padding = '12px';
        btn.innerHTML = 'üëÅÔ∏è‚Äçüó®Ô∏è';
        btn.title = '–ü–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É';
        statsVisible = false;
      } else {
        content.style.display = 'block';
        panel.style.minWidth = '260px';
        panel.style.padding = '18px';
        btn.innerHTML = 'üëÅÔ∏è';
        btn.title = '–ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É';
        statsVisible = true;
      }
    }

    window.refreshMap = refreshMap;
    window.toggleStats = toggleStats;
  </script>
</body>
</html>
